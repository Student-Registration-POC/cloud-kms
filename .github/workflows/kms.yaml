name: GCS Deployment

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the main branch
on:
  push:
    branches: [ main ]
    
permissions:
  id-token: write  # Allow GitHub Actions to request OIDC tokens
  contents: read   # Optional: If your workflow accesses the repository contents
  
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "deploy"
  deploy:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v2

    # Setup gcloud CLI
    - name: Authenticate to Google Cloud using OIDC
      id: auth
      uses: google-github-actions/auth@v2
      with:
        token_format: 'access_token'
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

    - name: Deploy via GCS
      run: |
        gcloud --version
        gsutil ls
        gsutil -m rm -rf gs://cloudkmsga/* || echo "$?"
        gsutil -m cp -r * gs://cloudkmsga/
